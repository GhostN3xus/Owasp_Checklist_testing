version: "3.8"

services:
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: file:./prisma/sqlite/sqlite.db
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-to-a-secure-random-string}
      NEXTAUTH_URL: http://localhost:3000
      PUBLIC_BASE_URL: http://localhost:3000
      PORT: 3000
      HOSTNAME: "0.0.0.0"
    volumes:
      - sqlite_data:/app/prisma/sqlite
      - exports_data:/tmp
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  init:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
      target: builder
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'Setting up database directory...' &&
      mkdir -p /app/prisma/sqlite &&
      echo 'Running migrations...' &&
      cd /app/prisma &&
      pnpm exec prisma migrate deploy &&
      echo 'Running seed...' &&
      pnpm exec prisma db seed &&
      echo 'Init completed!'
      "
    environment:
      DATABASE_URL: file:./prisma/sqlite/sqlite.db
      NODE_ENV: production
    volumes:
      - sqlite_data:/app/prisma/sqlite
    working_dir: /app

volumes:
  sqlite_data:
  exports_data:
