# üéØ Pentesting Profissional - Guia Completo

## Da Proposta ao Relat√≥rio Final - N√≠vel Expert

---

## üìñ √çndice

1. [O que √© Pentesting?](#oque-pentesting)
2. [Fases do Pentesting (PTES)](#fases-ptes)
3. [Pr√©-Engajamento](#pre-engajamento)
4. [Intelligence Gathering](#intelligence)
5. [Scanning & Enumeration](#scanning)
6. [Vulnerability Assessment](#vuln-assessment)
7. [Exploitation](#exploitation)
8. [Post-Exploitation](#post-exploitation)
9. [Relat√≥rio Profissional](#relatorio)
10. [Gest√£o de Projeto](#gerenciamento)

---

## O que √© Pentesting? {#oque-pentesting}

### üìå Defini√ß√£o Profissional

**Penetration Testing** = Teste de seguran√ßa autorizado que simula um ataque real para encontrar vulnerabilidades ANTES de hackers.

```
Pentesting vs Bug Bounty vs Red Team:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Aspecto     ‚îÇ  Pentesting  ‚îÇ  Bug Bounty  ‚îÇ  Red Team    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Dura√ß√£o      ‚îÇ 1-4 semanas  ‚îÇ Cont√≠nuo     ‚îÇ 1-6 meses    ‚îÇ
‚îÇ Escopo       ‚îÇ Definido     ‚îÇ Aberto       ‚îÇ Amplo        ‚îÇ
‚îÇ Objetivo     ‚îÇ Seguran√ßa    ‚îÇ Bugs         ‚îÇ Defesas      ‚îÇ
‚îÇ Documenta√ß√£o ‚îÇ Relat√≥rio    ‚îÇ Bounty       ‚îÇ Narrativa    ‚îÇ
‚îÇ Costo        ‚îÇ $$$$         ‚îÇ Pay-per-bug  ‚îÇ $$$$$        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîß Tipos de Pentesting

**1. Black Box (Nenhuma Informa√ß√£o)**
```
Conhecimento: Zero
‚îú‚îÄ Sem credenciais
‚îú‚îÄ Sem acesso a c√≥digo
‚îú‚îÄ Sem informa√ß√£o arquitetura
‚îî‚îÄ Resultado: Simula ataque real externo

Tempo: +Longo (recon, scanning)
Custo: ++Caro
Realismo: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
```

**2. White Box (Acesso Total)**
```
Conhecimento: Total
‚îú‚îÄ C√≥digo fonte fornecido
‚îú‚îÄ Credenciais admin
‚îú‚îÄ Documenta√ß√£o arquitetura
‚îî‚îÄ Resultado: Testa tudo inclusive internos

Tempo: -Curto
Custo: +Barato
Realismo: ‚≠ê‚≠ê
```

**3. Gray Box (Conhecimento Parcial)**
```
Conhecimento: Parcial
‚îú‚îÄ User credentials (n√£o admin)
‚îú‚îÄ Documenta√ß√£o b√°sica
‚îú‚îÄ Conhecimento dos sistemas
‚îî‚îÄ Resultado: Realista + foco

Tempo: M√©dio
Custo: M√©dio
Realismo: ‚≠ê‚≠ê‚≠ê‚≠ê
```

---

## Fases do Pentesting (PTES) {#fases-ptes}

### PTES - Penetration Testing Execution Standard

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FASE 1: PR√â-ENGAGEMENT                ‚îÇ
‚îÇ  ‚îî‚îÄ Contrato, escopo, timeline         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 2: INTELLIGENCE GATHERING (RECON)‚îÇ
‚îÇ  ‚îî‚îÄ OSINT, footprinting, enumeration   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 3: SCANNING & ENUMERATION        ‚îÇ
‚îÇ  ‚îî‚îÄ Nmap, vulnerability scanning       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 4: VULNERABILITY ASSESSMENT      ‚îÇ
‚îÇ  ‚îî‚îÄ An√°lise detalhada de vulnerabilidades
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 5: EXPLOITATION                  ‚îÇ
‚îÇ  ‚îî‚îÄ Explora√ß√£o t√©cnica                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 6: POST-EXPLOITATION             ‚îÇ
‚îÇ  ‚îî‚îÄ Escala√ß√£o, lateral movement        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  FASE 7: REPORTING                     ‚îÇ
‚îÇ  ‚îî‚îÄ Documento profissional              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Pr√©-Engajamento {#pre-engajamento}

### üìã Documento Cr√≠tico: Rules of Engagement (ROE)

**O ROE define:**

```
1. AUTORIZA√á√ÉO
   ‚îú‚îÄ Assinado por cliente
   ‚îú‚îÄ Legal review completo
   ‚îú‚îÄ Per√≠odo v√°lido (data/hora in√≠cio e fim)
   ‚îî‚îÄ Contatos de emerg√™ncia

2. ESCOPO
   ‚îú‚îÄ IPs/Dom√≠nios inclusos
   ‚îú‚îÄ Exclus√µes expl√≠citas
   ‚îú‚îÄ Tipo: Black/White/Gray Box
   ‚îú‚îÄ Aplica√ß√µes/Servi√ßos espec√≠ficos
   ‚îî‚îÄ Ambientes (produ√ß√£o vs staging)

3. LIMITES T√âCNICOS
   ‚îú‚îÄ Explora√ß√£o: At√© que ponto?
   ‚îú‚îÄ DoS: Permitido?
   ‚îú‚îÄ Social Engineering: Permitido?
   ‚îú‚îÄ Phishing: Permitido?
   ‚îú‚îÄ Evas√£o de detec√ß√£o: Permitido?
   ‚îî‚îÄ Modifica√ß√£o de dados: Permitido?

4. COMUNICA√á√ÉO
   ‚îú‚îÄ Contatos principais
   ‚îú‚îÄ Contatos de escala√ß√£o
   ‚îú‚îÄ Frequ√™ncia de update
   ‚îú‚îÄ Hor√°rios permitidos (09-17:00?)
   ‚îî‚îÄ Timezone

5. LIMITA√á√ïES LEGAIS
   ‚îú‚îÄ GDPR/LGPD compliance
   ‚îú‚îÄ PCI-DSS scope
   ‚îú‚îÄ Segredos comerciais
   ‚îú‚îÄ Dados pessoais
   ‚îî‚îÄ Propriedade intelectual

6. DISCLAIMER
   ‚îú‚îÄ Sem garantia de encontrar tudo
   ‚îú‚îÄ Responsabilidade por danos
   ‚îú‚îÄ Confidencialidade
   ‚îî‚îÄ Uso dos dados
```

### üìÑ Template ROE Profissional

```markdown
# RULES OF ENGAGEMENT (ROE)

## PROJETO: [Nome] - Penetration Test

**Data:** 01/01/2025
**Dura√ß√£o:** 2 semanas (01/01 - 14/01/2025)
**Tipo:** Gray Box Pentesting

## 1. AUTORIZA√á√ÉO

Este teste √© autorizado por:
- **Cliente:** [Empresa]
- **Aprovador:** [Nome, T√≠tulo]
- **Contato Principal:** [Email, Telefone]
- **Escala√ß√£o:** [Email, Telefone]

Assinado e datado: _______________

## 2. ESCOPO

**Inclu√≠do:**
- 192.168.1.0/24 (rede interna)
- app.company.com (aplica√ß√£o web)
- api.company.com (API REST)
- db.company.com (database) - LEITURA APENAS
- Windows Server 2019 (production)
- Linux servers (3 servidores)

**Exclu√≠do:**
- 192.168.2.0/24 (rede parceiros)
- backup.company.com (backup server - cr√≠tico)
- payment-gateway.com (terceiros)
- prod_database (modifica√ß√£o de dados)
- Qualquer servidor customer-facing

**Ambiente:**
- Produ√ß√£o (sem staging)
- Hor√°rios: Seg-Sex 09:00-17:00 UTC-3
- Fora desses hor√°rios apenas se emerg√™ncia acordada

## 3. LIMITES T√âCNICOS

**Permitido:**
- Explora√ß√£o de vulnerabilidades identificadas
- Credential theft + testing
- Lateral movement dentro do escopo
- DoS limitado (teste de rate limiting)
- Social engineering (email phishing)

**N√ÉO Permitido:**
- Modifica√ß√£o de dados produ√ß√£o
- Deletar dados/logs
- Instalar persist√™ncia permanente
- Acessar dados de clientes
- Revelar dados confidenciais
- DDoS ou ataques massivos

**Cr√≠tico:**
- Pedir PERMISS√ÉO antes de:
  - Modificar qualquer configura√ß√£o
  - Acessar dados sens√≠veis (PII, financeiro)
  - Realizar ataques que derrubem servi√ßos
  - Usar exploits n√£o documentados

## 4. COMUNICA√á√ÉO

**Contatos Principais:**
- IT Manager: john@company.com / (11) 98888-1111
- Security Lead: mary@company.com / (11) 98888-2222
- CISO (Escala√ß√£o): ciso@company.com / (11) 98888-3333

**Frequ√™ncia:**
- Daily standup: 09:00 cada dia
- Issues cr√≠ticas: ASAP (telefone)
- Relat√≥rio de progresso: Sexta-feira

## 5. CONFIDENCIALIDADE & LEGALIDADE

- Todos os dados obtidos s√£o CONFIDENCIAIS
- Relat√≥rio s√≥ para [3 pessoas listadas]
- Reten√ß√£o de dados: 30 dias, depois destrui√ß√£o
- Compliance: LGPD, GDPR, PCI-DSS

## 6. RESPONSABILIDADE

O Pentester n√£o √© respons√°vel por:
- Danos causados por explora√ß√£o
- Downtime de servi√ßos
- Perda de dados (dentro do escopo permitido)
- Vulnerabilidades n√£o descobertas

## ASSINATURAS

**Cliente:**
Nome: ________________
Cargo: ________________
Data: ________________

**Pentester/Empresa:**
Nome: ________________
Empresa: ________________
Data: ________________

Ambos concordam com os termos acima.
```

---

## Intelligence Gathering {#intelligence}

### üîç OSINT Estruturado

```
FASE: Intelligence Gathering
DURA√á√ÉO: 1-3 dias
OBJETIVO: M√°xima informa√ß√£o com zero detec√ß√£o

ATIVIDADES:
1. Footprinting passivo
   ‚îú‚îÄ Whois
   ‚îú‚îÄ DNS records
   ‚îú‚îÄ Certificate transparency logs
   ‚îî‚îÄ SSL/TLS analysis

2. Enumeration remota
   ‚îú‚îÄ Subdom√≠nios
   ‚îú‚îÄ IP ranges
   ‚îú‚îÄ Tecnologias
   ‚îî‚îÄ Identifica√ß√£o de vers√£o

3. OSINT p√∫blicas
   ‚îú‚îÄ LinkedIn (funcion√°rios, skills, tecnologias)
   ‚îú‚îÄ GitHub (c√≥digo exposto, keys)
   ‚îú‚îÄ Google dorking
   ‚îú‚îÄ Shodan, Censys
   ‚îî‚îÄ Breach databases

4. An√°lise de infraestrutura
   ‚îú‚îÄ CDN detection (CloudFlare, Akamai)
   ‚îú‚îÄ WAF fingerprinting
   ‚îú‚îÄ Load balancer detection
   ‚îî‚îÄ Proxy/reverse proxy

5. An√°lise hist√≥rica
   ‚îú‚îÄ Wayback machine
   ‚îú‚îÄ DNS history
   ‚îú‚îÄ WHOIS history
   ‚îî‚îÄ Archive.org
```

### üõ†Ô∏è Script Automatizado de Recon

```bash
#!/bin/bash
# comprehensive-recon.sh

TARGET_DOMAIN=$1
REPORT_DIR="recon_${TARGET_DOMAIN}"

mkdir -p $REPORT_DIR

echo "[*] Iniciando recon para $TARGET_DOMAIN"

# 1. Whois
echo "[+] WHOIS"
whois $TARGET_DOMAIN > $REPORT_DIR/whois.txt

# 2. DNS
echo "[+] DNS"
nslookup $TARGET_DOMAIN > $REPORT_DIR/nslookup.txt
dig $TARGET_DOMAIN +trace >> $REPORT_DIR/nslookup.txt
dig $TARGET_DOMAIN MX >> $REPORT_DIR/nslookup.txt
dig $TARGET_DOMAIN NS >> $REPORT_DIR/nslookup.txt

# 3. Subdom√≠nios
echo "[+] Subdom√≠nios"
sublist3r -d $TARGET_DOMAIN -o $REPORT_DIR/subdomains.txt

# 4. IP ranges
echo "[+] IP Ranges"
amass intel -d $TARGET_DOMAIN -o $REPORT_DIR/amass.txt

# 5. Tecnologia
echo "[+] Tecnologia"
whatweb https://$TARGET_DOMAIN > $REPORT_DIR/whatweb.txt

# 6. SSL Certificate
echo "[+] SSL Certificate"
echo | openssl s_client -servername $TARGET_DOMAIN -connect $TARGET_DOMAIN:443 2>/dev/null | openssl x509 -text -noout > $REPORT_DIR/ssl_cert.txt

# 7. GitHub dorking
echo "[+] GitHub Dorking"
echo "Procure manualmente em:"
echo "  site:github.com $TARGET_DOMAIN password"
echo "  site:github.com $TARGET_DOMAIN API_KEY"
echo "  site:github.com $TARGET_DOMAIN aws_access_key" > $REPORT_DIR/github_dorking_tips.txt

# 8. Shodan
echo "[+] Shodan (manual)"
echo "Procure em shodan.io:"
echo "  $TARGET_DOMAIN"
echo "  hostname:$TARGET_DOMAIN"
echo "  org:$TARGET_DOMAIN" >> $REPORT_DIR/shodan_tips.txt

# 9. Relat√≥rio consolidado
echo "[+] Consolidando"
cat $REPORT_DIR/*.txt > $REPORT_DIR/CONSOLIDATED_RECON.txt

echo "[*] Recon completo! Resultados em: $REPORT_DIR/"
```

---

## Scanning & Enumeration {#scanning}

### üîß Nmap Avan√ßado

```bash
#!/bin/bash
# nmap-comprehensive.sh

TARGET=$1

echo "[*] Nmap comprehensive scan: $TARGET"

# Fase 1: Port discovery r√°pido
echo "[+] Fase 1: Port discovery"
nmap -p- --min-rate 10000 -oX nmap1_ports.xml $TARGET

# Fase 2: Version detection + scripts
echo "[+] Fase 2: Version & Scripts"
nmap -sV --script vuln,default -oX nmap2_version.xml $TARGET

# Fase 3: OS detection
echo "[+] Fase 3: OS Detection"
nmap -O --osscan-guess -oX nmap3_os.xml $TARGET

# Fase 4: UDP scan (comum ser ignorado)
echo "[+] Fase 4: UDP"
nmap -sU -p 53,123,161,69 -oX nmap4_udp.xml $TARGET

# Consolidar
echo "[+] Consolidando resultados"
nmap -A -p- $TARGET -oA nmap_complete

echo "[*] Resultados em nmap_complete.*"
```

### üìä Vulnerability Scanning

```bash
#!/bin/bash

TARGET=$1

echo "[*] Vulnerability Assessment"

# Nessus (profissional, pago)
# /opt/nessus/bin/nessuscli scan --new --template "basic network scan" -o $TARGET

# OpenVAS (open source)
# openvas-cli -iR "OpenVAS Default" -T "Full and fast ultimate" --upload $TARGET

# Nuclei (r√°pido, templates)
nuclei -u https://$TARGET -t nuclei-templates/ -o nuclei_findings.txt

# OWASP ZAP (web apps)
zaproxy -cmd -quickurl https://$TARGET -quickout zap_report.html

# Trivy (containers)
trivy image myrepo/myimage:latest > trivy_findings.txt

# Snyk (dependencies)
snyk test --severity-threshold=high > snyk_findings.txt
```

---

## Exploitation {#exploitation}

### üéØ Metodologia de Explora√ß√£o Estruturada

```
ANTES DE EXPLORAR:

1. Validar autoriza√ß√£o
   ‚îú‚îÄ Verificar ROE
   ‚îú‚îÄ Confirmar escopo
   ‚îî‚îÄ Contatar cliente se d√∫vida

2. Testar em LAB primeiro
   ‚îú‚îÄ N√£o testar em produ√ß√£o
   ‚îú‚îÄ Documentar comportamento
   ‚îî‚îÄ Validar que n√£o quebra

3. Ter backup plan
   ‚îú‚îÄ Como reverter a mudan√ßa?
   ‚îú‚îÄ Cleanup script pronto?
   ‚îî‚îÄ Documenta√ß√£o de rollback

4. Ter monitoramento
   ‚îú‚îÄ Verificar logs
   ‚îú‚îÄ Alertas ativados?
   ‚îî‚îÄ Comunica√ß√£o com client
```

### üî® Exploit Execution Framework

```python
#!/usr/bin/env python3
"""
Framework de Execu√ß√£o de Exploit
- Logging estruturado
- Documenta√ß√£o autom√°tica
- Rollback capability
- Impact assessment
"""

import logging
import json
from datetime import datetime
from typing import Dict, List, Callable
import subprocess

class ExploitManager:
    def __init__(self, engagement_id: str, target: str):
        self.engagement_id = engagement_id
        self.target = target
        self.exploits_run = []
        self.changes_made = []

        # Setup logging
        log_file = f"exploit_execution_{datetime.now().isoformat()}.log"
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_file),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)

    def run_exploit(self,
                   name: str,
                   description: str,
                   exploit_func: Callable,
                   rollback_func: Callable = None,
                   impact: str = "MEDIUM") -> Dict:
        """
        Executar exploit com documenta√ß√£o

        Args:
            name: Nome do exploit (ex: "SQL Injection in login")
            description: Descri√ß√£o t√©cnica
            exploit_func: Fun√ß√£o que executa exploit
            rollback_func: Fun√ß√£o para reverter mudan√ßas
            impact: CRITICAL, HIGH, MEDIUM, LOW
        """

        self.logger.info(f"[*] Iniciando: {name}")

        try:
            # Executar exploit
            result = exploit_func()

            # Registrar sucesso
            exploit_record = {
                'timestamp': datetime.now().isoformat(),
                'name': name,
                'description': description,
                'status': 'SUCCESS',
                'impact': impact,
                'result': result,
                'rollback_available': rollback_func is not None
            }

            self.exploits_run.append(exploit_record)

            # Registrar mudan√ßa (para cleanup depois)
            if rollback_func:
                self.changes_made.append({
                    'exploit': name,
                    'rollback': rollback_func
                })

            self.logger.info(f"[+] Explorado com sucesso: {name}")
            return exploit_record

        except Exception as e:
            self.logger.error(f"[-] Erro ao explorar {name}: {e}")
            return {
                'name': name,
                'status': 'FAILED',
                'error': str(e)
            }

    def cleanup(self):
        """
        Reverter todas as mudan√ßas feitas
        """
        self.logger.info("[*] Iniciando limpeza")

        for change in reversed(self.changes_made):  # Reverter em ordem inversa
            try:
                change['rollback']()
                self.logger.info(f"[+] Limpeza: {change['exploit']}")
            except Exception as e:
                self.logger.error(f"[-] Erro ao limpar {change['exploit']}: {e}")

    def generate_report(self, filename: str = None):
        """
        Gerar relat√≥rio estruturado
        """
        if not filename:
            filename = f"exploit_report_{self.engagement_id}.json"

        report = {
            'engagement_id': self.engagement_id,
            'target': self.target,
            'date': datetime.now().isoformat(),
            'exploits_executed': self.exploits_run,
            'total_exploited': len([x for x in self.exploits_run if x['status'] == 'SUCCESS']),
            'total_failed': len([x for x in self.exploits_run if x['status'] == 'FAILED'])
        }

        with open(filename, 'w') as f:
            json.dump(report, f, indent=2)

        self.logger.info(f"[+] Relat√≥rio salvo em {filename}")
        return report


# Exemplo de uso
if __name__ == '__main__':
    manager = ExploitManager('ENG-2025-001', 'app.company.com')

    # Exploit 1: SQLi
    def sqlinjection_exploit():
        # Executar SQLi
        result = subprocess.run(['sqlmap', '-u', 'http://app/login', '-p', 'username'],
                              capture_output=True)
        return result.stdout.decode()

    def sqlinjection_rollback():
        # Nada para reverter (read-only)
        pass

    manager.run_exploit(
        name='SQL Injection in Login',
        description='Explora√ß√£o de SQL Injection em formul√°rio de login',
        exploit_func=sqlinjection_exploit,
        rollback_func=sqlinjection_rollback,
        impact='CRITICAL'
    )

    # Exploit 2: Default Credentials
    def default_creds_exploit():
        import requests
        resp = requests.post('http://app/admin',
                           data={'user': 'admin', 'password': 'admin123'})
        return {'status': resp.status_code}

    def default_creds_rollback():
        # Logout
        requests.post('http://app/logout')

    manager.run_exploit(
        name='Default Credentials',
        description='Admin panel com credenciais padr√£o n√£o alteradas',
        exploit_func=default_creds_exploit,
        rollback_func=default_creds_rollback,
        impact='CRITICAL'
    )

    # Cleanup e relat√≥rio
    manager.cleanup()
    manager.generate_report()
```

---

## Post-Exploitation {#post-exploitation}

### üìà Progress√£o Padr√£o

```
ACESSO INICIAL
    ‚Üì
ESCALA√á√ÉO DE PRIVIL√âGIO
    ‚Üì
DESCOBERTA INTERNA
    ‚Üì
LATERAL MOVEMENT
    ‚Üì
DADOS CR√çTICOS LOCALIZADOS
    ‚Üì
OBJETIVO ATINGIDO (ou n√£o)
```

### üéØ Checklist Post-Exploitation

```
AP√ìS GANHAR ACESSO INICIAL:

[ ] Validar acesso
    ‚îú‚îÄ Qual √© meu usu√°rio? (whoami)
    ‚îú‚îÄ Qual √© meu privil√©gio? (id, systeminfo)
    ‚îî‚îÄ Qual √© a m√°quina? (hostname, uname)

[ ] Coleta de informa√ß√£o
    ‚îú‚îÄ Listar usu√°rios locais
    ‚îú‚îÄ Verificar sudo/admin privileges
    ‚îú‚îÄ Listar processos rodando
    ‚îú‚îÄ Verificar servi√ßos em execu√ß√£o
    ‚îú‚îÄ Analisar network connections
    ‚îî‚îÄ Descobrir outros hosts na rede

[ ] Escala√ß√£o de privil√©gio
    ‚îú‚îÄ Procurar SUID binaries
    ‚îú‚îÄ Procurar weak sudo config
    ‚îú‚îÄ Procurar kernel exploits
    ‚îú‚îÄ Procurar configura√ß√£o fraca
    ‚îî‚îÄ Testar privilege escalation

[ ] Lateral movement
    ‚îú‚îÄ Descobrir outros hosts/IPs
    ‚îú‚îÄ Tentar acessar outros sistemas
    ‚îú‚îÄ Procurar credenciais armazenadas
    ‚îú‚îÄ Pass-the-hash / Kerberos
    ‚îî‚îÄ Mover para sistemas cr√≠ticos

[ ] Objetivo final
    ‚îú‚îÄ Encontrar dados sens√≠veis
    ‚îú‚îÄ Alcan√ßar servidor de BD
    ‚îú‚îÄ Acessar AD/centralized auth
    ‚îú‚îÄ Exfiltrar dados cr√≠ticos
    ‚îî‚îÄ Documentar impact
```

---

## Relat√≥rio Profissional {#relatorio}

### üìÑ Estrutura Executiva

```markdown
# PENETRATION TEST REPORT

## EXECUTIVE SUMMARY

[1-2 p√°ginas para C-level]

### Assessment Scope
- Per√≠odo: 01-14 Janeiro 2025
- Tipo: Gray Box Penetration Test
- Alvo: app.company.com + Infra Interna

### Key Findings
- **1 CRITICAL**: Remote Code Execution
- **3 HIGH**: SQL Injection, Default Credentials
- **7 MEDIUM**: XSS, Misconfiguration
- **12 LOW**: Information Disclosure

### Executive Risk Rating: 9.2 / 10 (CRITICAL)

### Business Impact
- Dados de clientes expostos: ~50,000 registros
- Potencial financeiro de perda: ~$2M (GDPR fines)
- Tempo de detec√ß√£o: <1 min (trivial com ferramentas)
- Reputa√ß√£o: Alta probabilidade de viola√ß√£o p√∫blica

### Immediate Actions Required
1. Patch RCE vulnerability (ASAP)
2. Change default credentials (hoje)
3. Implement WAF rules (dias)
4. Full security audit (semanas)

---

## DETAILED FINDINGS

### Finding #1: Remote Code Execution via File Upload [CRITICAL]

**CVSS 3.1 Score:** 9.8 (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
**CWE:** CWE-434 (Unrestricted Upload)

#### Description
A aplica√ß√£o permite upload de arquivos sem valida√ß√£o adequada,
permitindo RCE atrav√©s de upload de web shell.

#### Proof of Concept
```bash
# Enviar arquivo PHP
curl -F "file=@shell.php" http://app.local/upload

# Acessar shell
curl http://app.local/uploads/shell.php?cmd=id

# Resultado: uid=33(www-data) gid=33(www-data)...
```

#### Impacto T√©cnico
- Execu√ß√£o de comando arbitr√°rio como www-data
- Possibilidade de escala√ß√£o para root
- Lateral movement para BD
- Exfiltra√ß√£o de dados

#### Impacto Comercial
- Dados de ~50k clientes expostos
- Poss√≠vel exfiltra√ß√£o de IP
- Downtime de servi√ßo
- Multa GDPR: at√© 4% da receita anual

#### Remedia√ß√£o
```python
# Valida√ß√£o de arquivo
def safe_upload(file):
    # 1. Validar extens√£o
    allowed_ext = ['pdf', 'docx', 'xlsx']
    if not file.filename.rsplit('.', 1)[1].lower() in allowed_ext:
        abort(400)

    # 2. Validar MIME type real
    import magic
    mime = magic.from_buffer(file.read(1024), mime=True)
    file.seek(0)
    if mime not in ['application/pdf', 'application/msword']:
        abort(400)

    # 3. Scan com antiv√≠rus
    if not scan_with_clamscan(file):
        abort(400)

    # 4. Salvar em local n√£o-execut√°vel
    filename = secure_filename(file.filename)
    filepath = os.path.join('/uploads_secure', filename)
    file.save(filepath)

    # 5. Servir com headers seguros
    return send_file(filepath, as_attachment=True)
```

#### Recomenda√ß√£o de Priorit√°rio
- **Imediato:** Disable upload feature or validate properly
- **24h:** Patch aplica√ß√£o
- **1 semana:** Audit de todos os uploads hist√≥ricos

---

## TIMELINE & SEVERITY

| # | Vulnerabilidade | Severidade | Encontrada | Remedia√ß√£o |
|---|-----------------|-----------|----------|-----------|
| 1 | RCE File Upload | CRITICAL | Dia 1 | Imediato |
| 2 | SQL Injection | HIGH | Dia 2 | 24h |
| 3 | Default Creds | HIGH | Dia 2 | 24h |
| 4 | XSS Stored | MEDIUM | Dia 3 | 1 semana |
| ... | ... | ... | ... | ... |

---

## RECOMMENDATIONS

### Immediate (24h)
1. Patch RCE via input validation
2. Change all default credentials
3. Implement rate limiting on login

### Short-term (1 week)
1. Deploy WAF with OWASP rules
2. Setup SIEM/logging
3. Conduct security code review

### Medium-term (1 month)
1. Implement secure SDLC
2. Automated security testing in CI/CD
3. Employee security training

### Long-term (3-6 months)
1. Bug bounty program
2. Continuous pentesting (quarterly)
3. Security culture development

---

## APPENDICES

### A. Tools Used
- Nmap 7.92
- Burp Suite Community
- SQLMap 1.5.3
- Metasploit Framework 6.2

### B. Proof of Concept Scripts
[Scripts.zip - files/poc_scripts.zip]

### C. Full Nmap Output
[nmap_results.xml]

### D. Screenshots
[screenshots/ folder]

### E. Gloss√°rio
[D√©fini√ß√µes de termos t√©cnicos]

---

## DISCLAIMER

Este relat√≥rio cont√©m informa√ß√µes confidenciais e n√£o pode ser divulgado sem permiss√£o.
Este teste foi conduzido dentro dos par√¢metros acordados no ROE.
As vulnerabilidades foram reportadas responsavelmente.
```

---

## Gest√£o de Projeto {#gerenciamento}

### üìÖ Cronograma Padr√£o (2 Semanas)

```
SEMANA 1:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Seg | Intelligence Gathering ‚îÇ
‚îÇ Ter | OSINT + Scanning       ‚îÇ
‚îÇ Qua | Scanning cont√≠nuo      ‚îÇ
‚îÇ Qui | Vulnerability Assessment
‚îÇ Sex | Prepara√ß√£o Explora√ß√£o  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

SEMANA 2:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Seg | Exploitation Phase 1    ‚îÇ
‚îÇ Ter | Exploitation Phase 2    ‚îÇ
‚îÇ Qua | Post-Exploitation       ‚îÇ
‚îÇ Qui | Cleanup + Documenta√ß√£o  ‚îÇ
‚îÇ Sex | Relat√≥rio Final + Debrief
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üìä Tracking de Atividades

```python
#!/usr/bin/env python3
"""
Pentesting Activity Tracker
- Logging estruturado
- Timeline de atividades
- Evid√™ncia documental
"""

from datetime import datetime
import json

class ActivityLogger:
    def __init__(self, engagement_id: str):
        self.engagement_id = engagement_id
        self.activities = []

    def log(self, category: str, description: str,
            severity: str = 'INFO', evidence: dict = None):
        """
        Log estruturado de atividade
        """
        activity = {
            'timestamp': datetime.now().isoformat(),
            'category': category,  # SCANNING, EXPLOITATION, DISCOVERY
            'description': description,
            'severity': severity,  # INFO, MEDIUM, HIGH, CRITICAL
            'evidence': evidence or {}
        }

        self.activities.append(activity)
        print(f"[{severity}] {category}: {description}")

    def export_timeline(self, filename: str = 'timeline.json'):
        """
        Exportar timeline para relat√≥rio
        """
        with open(filename, 'w') as f:
            json.dump(self.activities, f, indent=2)

# Uso
logger = ActivityLogger('ENG-2025-001')

logger.log('SCANNING', 'Nmap full port scan iniciado')
logger.log('SCANNING', 'Porta 22 SSH detectada', 'INFO')
logger.log('DISCOVERY', 'Vers√£o SSH: OpenSSH 7.4', 'INFO',
          {'version': '7.4', 'cve': 'CVE-2018-15473'})
logger.log('VULNERABILITY', 'SSH username enumeration poss√≠vel', 'MEDIUM',
          {'tool': 'OpenSSH User Enumeration', 'impact': 'Account names'})

logger.export_timeline()
```

---

## üéØ Checklist Final - Pentesting Completo

```
PR√â-ENGAJAMENTO:
[ ] ROE assinado
[ ] Escopo definitivo
[ ] Contatos confirmados
[ ] Autoriza√ß√£o por escrito
[ ] Lab setup completo

FASE 1: INTELLIGENCE
[ ] OSINT completo
[ ] Tecnologias identificadas
[ ] Pessoal pesquisado (LinkedIn)
[ ] Hist√≥rico consultado (Wayback)

FASE 2: SCANNING
[ ] Nmap full scan
[ ] UDP scan
[ ] Vulnerability scan
[ ] WAF bypass testing
[ ] CMS fingerprinting

FASE 3: EXPLORA√á√ÉO
[ ] Top 10 testado completo
[ ] PoC criado para cada
[ ] Impacto validado
[ ] Documenta√ß√£o de explora√ß√£o

FASE 4: P√ìS-EXPLORA√á√ÉO
[ ] Escala√ß√£o testada
[ ] Lateral movement testado
[ ] Dados cr√≠ticos localizados
[ ] Objetivo atingido (ou limitado)

FASE 5: CLEANUP
[ ] Todas mudan√ßas revertidas
[ ] Backdoors removidos
[ ] Logs verificados
[ ] Confirma√ß√£o com cliente

FASE 6: RELAT√ìRIO
[ ] Executive summary
[ ] Findings detalhados
[ ] PoC documentado
[ ] Recomenda√ß√µes priorizadas
[ ] Timeline inclu√≠da

P√ìS-TESTE:
[ ] Relat√≥rio entregue
[ ] Debriefing realizado
[ ] Dados destru√≠dos
[ ] Feedback coletado
[ ] Follow-up agendado
```

---

<div align="center">

**‚≠ê Pentesting √© 80% documenta√ß√£o, 20% explora√ß√£o**

**Relat√≥rio profissional determina valor de seu trabalho**

**Sempre priorize seguran√ßa do cliente sobre agressividade do teste**

**Do iniciante ao expert: Processo estruturado > Ferramentas**

</div>
